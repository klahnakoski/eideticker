# encoding: utf-8
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this file,
# You can obtain one at http://mozilla.org/MPL/2.0/.
#
# Author: Kyle Lahnakoski (kyle@lahnakoski.com)
#

from __future__ import unicode_literals
from util.cnv import CNV
from util.collections import reverse
from util.env.logs import Log
from util.queries import windows, Q
from welchs_ttest import welchs_ttest

entropies = [
    4.989581808861076, 5.064426400979757, 5.014564045137374, 4.984364278170482, 5.00425616531406, 5.016558561104198, 5.0366350652672445, 4.948167694555852, 4.9892157148166545,
    5.192063149366924, 5.005788798027799, 4.990532326321859, 4.989691823245617, 5.194704179516094, 4.989227853259563, 4.993613978170332, 4.955504455325914, 5.0411516125007925, 5.020857731098612,
    4.981323434701142, 5.210965557557406, 4.942501422651571, 5.011511113820382, 4.980958910182712, 4.989971426785354, 5.050947682235622, 5.0156683158833175, 5.2152576602137, 4.999256185977055,
    5.009466827372494, 5.008497064698458, 4.998780008255542, 5.006726261301381, 4.940492639924037, 4.989021399244895, 5.030348758785199, 5.202465690189136, 4.994559874368434, 4.9995310136290465,
    5.2060633088485355, 5.0355233912885256, 5.141655320089119, 4.961072008370474, 5.119786429619993, 4.934656184013913, 4.898170282789855, 4.83294137962324, 4.731132268419057, 4.817050309354632,
    4.826848128893557, 4.718683485565243, 4.727554482206718, 4.6658756373937855, 4.643985126385631, 4.652644014101421, 4.593768278442099, 4.753671929481182, 4.636881487209591, 4.754131574545948,
    4.662865188184091, 4.656689844549726, 4.665947072922886, 4.6562573801921125, 4.393652925797295, 4.662504514560831, 4.740876498543705, 4.464247755576698, 4.739516195018967, 4.654872197586011,
    4.756552861269549, 4.694929341411576, 4.648274036858921, 4.499574272409469, 4.656730471256801, 4.7523037586692105, 4.629692610223759, 4.659504220710376, 4.749254384730566, 4.538363999744726,
    4.106383145397159, 3.972974299741164, 3.8665904006589193, 3.996750139720075, 3.938005826314192, 3.962409080625796, 4.013662992245826, 3.953823483182541, 3.985278801894092, 4.178250620473712,
    4.211053344673828, 4.180982547987266, 4.204433365312373, 4.225385549970993, 4.220312580338632, 4.2414203080296495, 4.205448378221008, 4.23929263954559, 4.212874844904442, 4.238894013576742,
    4.214138140006875, 4.246136760853181, 4.203873304117228, 4.235391390795822, 4.361252507729366, 4.256661448218736, 4.219992852800938, 4.204869735857841, 4.2406887570643255, 4.226498608936532,
    4.24309872277076, 4.246600590428627, 4.236222267852236, 4.264156501511342, 4.180769319075417, 4.237266973735566, 4.242571504444348, 4.243775185437151, 4.343773552652146, 4.227655385972499,
    4.190672306612385, 4.380811181071156, 4.665985472914865, 4.783091697707172, 4.7940934460500095, 4.735178809410385, 4.789745086727149, 4.776957029425929, 4.782639253629081, 4.791708011674202,
    4.774849676983534, 4.91481271259722, 4.764778844656278, 4.785249675618453, 4.732843688040767, 4.796015247199846, 4.7865297390269586, 4.78905947319832, 4.79587884187246, 4.897223931015626,
    4.801982193059371, 4.7822523379302195, 4.800935381444088, 4.837403638426204, 4.784850432687871, 4.627943473378643, 4.805319554765023, 4.734596896915711, 4.781538436458373, 4.786025086874464,
    4.781644797980171, 4.777442393100885, 4.778224392317906, 4.776841146680214, 4.7339808944010295, 4.793384057767413, 4.768853185603573, 4.801568279067611, 4.669673665711228, 4.76789848583979,
    4.66350542647189, 4.7919511738711265, 4.801479499769846, 4.721678625965548, 4.765542341484047, 4.820804583438452, 4.82228538130252, 4.765864186417973, 4.798877048254346, 4.713517939996854,
    4.798607657355858, 4.797111583080553, 4.781019647879589, 4.765231405613315, 4.801089506801742, 4.792322229981095, 4.765762110288645, 4.822946861892136, 4.755213052839596, 4.799936488305292,
    4.802710798841172, 4.77853324147996, 4.814282553102897, 4.7118996005208675, 4.793150262642001, 4.730835392856327, 4.794216229134317, 4.757577001841466, 4.901903081664217, 4.798193157617278,
    4.7819401966078345, 4.781351091282536, 4.822373502885651, 4.840374767314283, 4.780891604065065, 4.819374451396828, 4.778178396064579, 4.790178419000871, 4.845822911342804, 4.794352479193241,
    4.798654829636968, 4.793448969401561, 4.900750078484177, 4.796500636206805, 4.800440125653254, 4.784859412473893, 4.79546194898183, 4.764599646919974, 4.797266759328939, 4.84420619527368,
    4.799708397725785, 4.734253125057875, 4.734027465652431, 4.83630437175297, 4.8170826924297785, 4.767796755218249, 4.80175969183982, 4.765884023619711, 4.819365956821523, 4.7831071729002765,
    4.848414201765827, 4.776729692038976, 4.796088700445459, 4.726603521513497, 4.780394705212675, 4.7881890452379166, 4.802350699949018, 4.79230404567407, 4.767008334783737, 4.797045060107558,
    4.816352547931305, 4.761942311472276, 4.72751545310263, 4.834551943275634, 4.732868178212572, 4.792776053225745, 4.78711690655253, 4.797809424548622, 4.800227852467629, 4.7685966537324465,
    4.764986231807256, 4.794922010839723, 4.7923173777981605, 4.82804484221946, 4.918433112497963, 4.736428243811921, 4.676488299362626, 4.8978299632069255, 4.896574922476372, 4.769367058940918,
    4.915813653565417, 4.796560303654752, 4.71069612520674, 4.767699732024749, 4.76485985558996, 4.799454651445615, 4.794261979883214, 4.81465403594949, 4.797836665437709, 4.800050179810868,
    4.789716775851533, 4.831340038824098, 4.779825224034582, 4.78009207141629, 4.793147021444156, 4.8041531034406795, 4.781623195523016, 4.82949695354739, 4.765438212179468, 4.7558778688148236,
    4.747273242235969, 4.781535345346597, 4.786835104305862, 4.802098558768932, 4.7664505369756425, 4.801388536081724, 4.733531970547858, 4.781810302578871, 4.730384060233842, 4.7872385648744595,
    4.7761184270274395, 4.770252327257923, 4.797631053627719, 4.799712812058302, 4.903065361913165, 4.791548024517443, 4.797721718060225, 4.796848182290515, 4.767912897332778, 4.792179464951898,
    4.792171980302342, 4.733542493217945, 4.764152887941085, 4.836573928563189, 4.800455084333724, 4.7355285027581395, 4.797683612007453, 4.793221642883685, 4.737902179668671, 4.772763732095366,
    4.797032409904509, 4.8000420847957095, 4.913076613960938, 4.764956008672145, 4.788293983151389, 4.798850962383027, 4.778836654570812, 4.730701445944644, 4.782819572707507, 4.772731330665718,
    4.803254137048241, 4.914281037560998, 4.827626187421398, 4.787384023089526, 4.7797740838455836, 4.799082994879937, 4.740573922717693, 4.763552864337023, 4.79356011621139, 4.765487489202082,
    4.782797454470817, 4.790744262456034, 4.80082488759549, 4.789805077170239, 4.79801515784972, 4.797486221241561, 4.794850019816366, 4.725877883000968, 4.7980889849055535, 4.724110870697424,
    4.801398842483672, 4.789951560668702, 4.788205294772717, 4.780701388245026, 4.834304271303063, 4.7346303588580225, 4.768368815354197
]

entropies2 = [
    4.171931067102017, 4.173403892963583, 4.159803312082803, 4.151108159658928, 4.094189660856051, 4.178764291105587, 4.16388871073443, 4.168090406906671, 4.113716758028353, 4.17833626006261,
    4.176809330878207, 4.16160643381115, 4.181135944929131, 4.152396108505049, 4.18714314953664, 4.150686703316897, 4.159831604042952, 4.163804167664933, 4.098855227222306, 4.096185373117086,
    4.169727612430386, 4.135459742048814, 4.132108550598459, 4.1318563989817685, 4.125542340786413, 4.164578462704073, 4.170333949255375, 4.1704421987108535, 4.157896852644319, 4.345484388056896,
    4.263479134382322, 4.203518382151519, 4.095322761818493, 4.064047371500066, 3.9785238306088524, 3.8777999009275086, 3.8025044587582473, 3.7509292920763357, 3.7203924678435225, 3.636635599669218,
    3.3996575536958535, 3.1197911767895166, 2.9051928967092513, 2.6386570298924306, 2.288167858861763, 1.8884931092085468, 0.9373070631258825, 0.6778660173016116, 0.6278475244492445,
    0.6141242732181987, 0.6126695370858064, 0.6075284682511951, 0.6033851467022137, 0.6067641355698139, 0.6097024329062816, 0.6053801469442561, 0.6119743472570155, 0.604229133383804,
    0.5998537035746788, 0.6113085097828405, 0.6059291277894264, 0.6058874147319224, 0.6030402384499556, 0.6069545530542159, 0.6112179838772474, 0.6081675572056023, 0.6091646938673256,
    0.6041699062855983, 0.6053138223074217, 0.6034173564469384, 0.6018755355237825, 0.6028447996228443, 0.6024536204251314, 0.6088153717621135, 0.6074120265718903, 0.6125173602563904,
    0.608190388937803, 0.6072951732624193, 0.6110863147110432, 0.6074176095991387, 0.6044501861666655, 0.6054299487087853, 0.5996514204647553, 0.6042275364922413, 0.6024107134531861,
    0.5978821610428717, 0.6069239175075823, 0.6097021352733712, 0.6065625401038925, 0.6106340736251273, 0.6073018223040384, 0.6101853192206153, 0.6111615666020567, 0.6125880613881421,
    0.6092304546105197, 0.6024961442568749, 0.6084291721789946, 0.6021183329278244, 0.6018287559614441, 0.6072038484988114, 0.6005674640952132, 0.6084965314768892, 0.6119566253521543,
    0.6086217946047091, 0.6103523833462675, 0.6098950192218472, 0.6039562341249366, 0.6102709518433523, 0.6062570245210207, 2.52252702778927, 2.8827390040298164, 2.8798325175869963, 2.850596548607215,
    2.8591121639145474, 2.8854191383613554, 2.854239864560646, 2.857193726174489, 2.8646295679928877, 2.9410981729462162, 3.1713703979627232, 3.1707238006055323, 3.173203925194769, 3.18180121004283,
    3.1764162886092087, 3.1898775578777254, 3.199823003902119, 3.1959081356974006, 3.196210285419401, 3.1814518318319727, 3.198259211212343, 3.1989429351165115, 3.20898864552127, 3.1999198895321097,
    3.201047090068434, 3.216408914388313, 3.2025608533939254, 3.203012698178702, 3.196843074803808, 3.19983180399885, 3.194098022982267, 3.1954068577600823, 3.1985633478963558, 3.1940251247178617,
    3.1986168749688484, 3.1990796064603257, 3.2029027961044583, 3.20472368951045, 3.2036238099605225, 3.2021686709671955, 3.2045693019052335, 3.196916972836223, 3.2038052549842324, 3.2073542351889226,
    3.216339114429045, 3.1963007739407936, 3.20196753550539, 3.2150712455244954, 3.2107071846373962, 3.204292356681875, 3.202705828607277, 3.2043491391637318, 3.202576090306117, 3.203733436012958,
    3.196808687804539, 3.2009856267929715, 3.197468327804938, 3.196125622341816, 3.3248877346845536, 3.7627185962918954, 3.8665653362058303, 3.8969115685895335, 3.9014118256005896, 3.9059513322857278,
    3.9107765866371524, 3.900073426347331, 3.898997484019571, 3.896097610389826, 3.8940742918507785, 3.9041995129406293, 3.9050335407777497, 3.905810037723941, 3.897664617733978, 3.9152211853942664,
    3.8193498511418054, 3.8263538394929473, 3.8212226804503167, 3.8255152286014193, 3.9046076358739623, 3.9025327580888063, 3.896382943582766, 3.893362703663842, 3.907300288841471, 3.906120307454722,
    3.90091124709363, 3.8947420772678525, 3.892987706623136, 3.899951731199964, 3.905966208423959, 3.9018884975400505, 3.8206970041843302, 3.8995189785972553, 3.9036029734240816, 3.805621419059981,
    3.8896493813691078, 3.8997466801009417, 3.9034603091479356, 3.9008524255737984, 3.8955095326215323, 3.897443829387783, 3.8974030141560863, 3.900562513564711, 3.8247955906291913,
    3.8990487406167844, 3.805493882731761, 3.8181955683072584, 3.9015764613615733, 3.8935450842000767, 3.8973679024742935, 3.818383793998398, 3.898979637396504, 3.894663362915707, 3.89628458706591,
    3.893524018922717, 3.9038400102236333, 3.902505571397693, 3.820615603312464, 3.897237308683263, 3.9096963240237725, 3.8975435606630837, 3.892794428895771, 3.89059943633688, 3.8916045526881384,
    3.911862530634402, 3.8941830508604807, 3.9016872085703462, 3.8995762255676123, 3.8985985599359068, 3.80486572243181, 3.819693615120004, 3.9054780878043482, 3.8198225551596288, 3.9104135459763394,
    3.9071691985273627, 3.900298000672506, 3.902543253166604, 3.903841434978056, 3.8166244663996434, 3.9013275926182254, 3.9060774654116477, 3.8999280166499104, 3.899926971740934, 3.9076916066462895,
    3.8226873689296856, 3.805395695834781, 3.8924401539722213, 3.8161711291368623, 3.8986803032934794, 3.891541134308255, 3.905012056417697, 3.9022601779655854, 3.8967862816638705, 3.8947971163294928,
    3.895854343092351, 3.8995278557188686, 3.9040311382018213, 3.8211211728180627, 3.900166694818719, 3.8005920955154227, 3.8914929331988017, 3.810177251162652, 3.9021257615324534, 3.892586541242383,
    3.893601246708337, 3.8188882526088905, 3.8982505132275165, 3.906642801702107, 3.901306133965883, 3.8125717313978535, 3.823181632621592, 3.8979755028937144, 3.9021466907400995, 3.8993103568315495,
    3.9010487322754055, 3.8994126193534817, 3.903679250780366, 3.8976422488428835, 3.9066600651991505, 3.903580809429186, 3.821697985739114, 3.8214371991803993, 3.820835013816367, 3.900976083251929,
    3.8974049734744143, 3.8193078263192195, 3.898723339405653, 3.8923537408995004, 3.9020049080821484, 3.9008639808293273, 3.9056757923367806, 3.8926057742443465, 3.9008763761054057,
    3.8981957595445698, 3.898917116937229, 3.8244538156290706, 3.901016892847759, 3.901124706435961, 3.8928922287771015, 3.9023972644106526, 3.902190720342786, 3.893186941373201, 3.891169533576841,
    3.8982250972074897, 3.8938511676198604, 3.9019819151682364, 3.8190307911983767, 3.826217319012532, 3.9062045929976854, 3.902609531445898, 3.9026627911090013, 3.8999685093088723, 3.89714062303729,
    3.906176766667411, 3.905841906201129, 3.8132310639433666, 3.9030329325736832, 3.908088813319847, 3.9030202554597455, 3.904225990543872, 3.9029249708667564, 3.8179903303733638, 3.900808820888968,
    3.9085348497202266, 3.898623137647547, 3.8970816223334905, 3.8932629811117603
]


# waves = numpy.fft.fft(avg)
# abs_waves = [abs(w) for w in waves]
#
# Log.start()
# Log.note(CNV.object2JSON(abs_waves[:256:]))
# Log.stop()

results = Q.run({
    "from": {
        "from": [{"entropy": e} for e in entropies2],
        "window": [{
            "name": "before",
            "value": lambda r: r.entropy,
            "aggregate": windows.Stats(),
            "range": {"min": -20, "max": 0}
        }, {
            "name": "after",
            "value": lambda r: r.entropy,
            "aggregate": windows.Stats(),
            "range": {"min": 0, "max": 20}
        }, {
            "name": "confidence",
            "value": lambda r: welchs_ttest(r.before, r.after).confidence
        }]
    },
    "select": ["entropy", "confidence", {"name": "before", "value": "before.mean"}, {"name": "after", "value": "after.mean"}]
})


# GO BACKWARDS AND FIND THE FIRST PEAK (THAT'S BEYOND A CERTAIN THRESHOLD)
maximum = 0.0
stop = -1
for i, r in enumerate(reverse(results)):
    if r.confidence > 3:
        if r.confidence > maximum:
            maximum = r.confidence
        else:
            stop = len(results) - i
            break

Log.start()
Log.note(CNV.list2tab(results))
Log.note("Action stopped at: {{stop}}", {"stop": stop})
Log.stop()
